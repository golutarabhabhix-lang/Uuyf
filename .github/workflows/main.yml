name: RDP Self-Hosted Stable

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'RDP session duration (minutes)'
        required: true
        default: '120'

jobs:
  rdp:
    runs-on: [self-hosted, windows, x64]
    timeout-minutes: 300

    steps:
      - name: System Info
        shell: pwsh
        run: |
          Write-Host "=== SYSTEM INFO ==="
          $ram = (Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory / 1GB
          Write-Host "RAM: $([math]::Round($ram,2)) GB"
          $cpu = Get-CimInstance Win32_Processor
          Write-Host "CPU: $($cpu.Name)"

      - name: Enable RDP
        shell: pwsh
        run: |
          Write-Host "Enabling RDP..."
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Restart-Service TermService -Force
          Write-Host "RDP Enabled"

      - name: Create RDP User
        shell: pwsh
        run: |
          $user = "rdpuser"
          $pass = "Rdp@123456"

          $secure = ConvertTo-SecureString $pass -AsPlainText -Force
          if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
            Set-LocalUser -Name $user -Password $secure
          } else {
            New-LocalUser -Name $user -Password $secure -PasswordNeverExpires
          }

          Add-LocalGroupMember -Group "Administrators" -Member $user -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user -ErrorAction SilentlyContinue

          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Show Connection Info
        shell: pwsh
        run: |
          try {
            $ip = Invoke-RestMethod https://api.ipify.org
          } catch {
            $ip = "CHECK ROUTER IP"
          }

          Write-Host "=============================="
          Write-Host "RDP READY"
          Write-Host "IP: $ip"
          Write-Host "PORT: 3389"
          Write-Host "USER: $env:RDP_USER"
          Write-Host "PASS: $env:RDP_PASS"
          Write-Host "=============================="

      - name: Keep Session Alive
        shell: pwsh
        run: |
          $mins = [int]"${{ github.event.inputs.duration }}"
          $end = (Get-Date).AddMinutes($mins)

          while ((Get-Date) -lt $end) {
            Write-Host "RDP ACTIVE - Remaining: $([math]::Round(($end-(Get-Date)).TotalMinutes)) min"
            Start-Sleep 60
          }

          Write-Host "Session ended"              Set-LocalUser -Name "TestUser64GB" -Password $securePass
              Write-Host "ğŸ”„ User password updated"
          } else {
              New-LocalUser -Name "TestUser64GB" -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Write-Host "ğŸ‘¤ New user created"
          }
          
          # Add to groups
          Add-LocalGroupMember -Group "Administrators" -Member "TestUser64GB" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TestUser64GB" -ErrorAction SilentlyContinue
          
          # Set password never expires
          Set-LocalUser -Name "TestUser64GB" -PasswordNeverExpires $true
          
          # Store credentials
          echo "RDP_USER=TestUser64GB" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$simplePassword" >> $env:GITHUB_ENV
          
          Write-Host "âœ… User configured: TestUser64GB"
        shell: pwsh

      - name: Optimize System Performance
        run: |
          Write-Host "ğŸš€ OPTIMIZING SYSTEM PERFORMANCE..."
          
          # Set power plan to high performance
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # Disable visual effects for better RDP performance
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2
          
          # Optimize for background services
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl" -Name "Win32PrioritySeparation" -Value 38
          
          # Disable Windows animations
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "UserPreferencesMask" -Value ([byte[]](144,18,3,128,16,0,0,0))
          
          Write-Host "âœ… System optimized for performance"
        shell: pwsh

      - name: Get Network Information
        run: |
          Write-Host "ğŸŒ NETWORK INFORMATION"
          
          # Get public IP
          $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org").Trim()
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          
          # Get local IP
          $localIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -like "*Ethernet*" -or $_.InterfaceAlias -like "*Wi-Fi*"} | Select-Object -First 1).IPAddress
          echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
          
          Write-Host "Public IP: $publicIP"
          Write-Host "Local IP: $localIP"
          
          # Test RDP port
          $portTest = Test-NetConnection -ComputerName $localIP -Port 3389 -WarningAction SilentlyContinue
          if ($portTest.TcpTestSucceeded) {
              Write-Host "âœ… RDP Port 3389 is open and accessible"
          } else {
              Write-Host "âš ï¸ RDP Port test failed locally"
          }
        shell: pwsh

      - name: Install Performance Monitoring Tools (Optional)
        if: ${{ github.event.inputs.test_mode == 'yes' }}
        run: |
          Write-Host "ğŸ“Š INSTALLING TEST TOOLS..."
          
          # Install Chocolatey (if not present)
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          }
          
          # Install useful tools for testing
          choco install sysinternals -y --no-progress
          choco install cpu-z -y --no-progress
          choco install hwinfo -y --no-progress
          choco install 7zip -y --no-progress
          
          Write-Host "âœ… Test tools installed"
        shell: pwsh

      - name: Display RDP Access Information
        run: |
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "                     ğŸš€ 64GB RDP READY! ğŸš€"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸ“Œ CONNECTION DETAILS:"
          Write-Host "   Public IP: $env:PUBLIC_IP"
          Write-Host "   Local IP:  $env:LOCAL_IP"
          Write-Host "   Port:      3389"
          Write-Host ""
          Write-Host "ğŸ‘¤ CREDENTIALS:"
          Write-Host "   Username:  $env:RDP_USER"
          Write-Host "   Password:  $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "ğŸ”§ SYSTEM SPECS:"
          $mem = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object TotalPhysicalMemory
          $ramGB = [math]::Round($mem.TotalPhysicalMemory / 1GB, 2)
          Write-Host "   RAM:       $ramGB GB"
          $cpu = Get-CimInstance -ClassName Win32_Processor
          Write-Host "   CPU:       $($cpu.Name)"
          Write-Host ""
          Write-Host "â° SESSION DURATION: ${{ github.event.inputs.duration }} minutes"
          Write-Host "ğŸ”“ MODE: ${{ github.event.inputs.test_mode == 'yes' && 'TEST MODE (NLA Disabled)' || 'SECURE MODE' }}"
          Write-Host ""
          Write-Host "ğŸ’¡ TIPS:"
          Write-Host "   1. Use mstsc.exe to connect"
          Write-Host "   2. For test mode, uncheck 'Always ask for credentials'"
          Write-Host "   3. Set display to 1920x1080 for best performance"
          Write-Host ""
          Write-Host "âš ï¸  WARNING: This session will auto-terminate after ${{ github.event.inputs.duration }} minutes"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          
          # Save info to file
          $info = @"
64GB RDP ACCESS INFORMATION
===========================
Timestamp: $(Get-Date)
Connection:
  - Public IP: $env:PUBLIC_IP
  - Local IP:  $env:LOCAL_IP
  - Port:      3389

Credentials:
  - Username: $env:RDP_USER
  - Password: $env:RDP_PASSWORD

System:
  - RAM: $ramGB GB
  - CPU: $($cpu.Name)
  - Mode: ${{ github.event.inputs.test_mode == 'yes' && 'TEST' || 'SECURE' }}
  
Connection String:
  mstsc /v:$env:PUBLIC_IP
"@
          
          $info | Out-File -FilePath "$env:GITHUB_WORKSPACE\RDP_Access_Info.txt"
          Write-Host "ğŸ“„ Access info saved to RDP_Access_Info.txt"
        shell: pwsh

      - name: Active Session Timer
        run: |
          $duration = ${{ github.event.inputs.duration }}
          $endTime = (Get-Date).AddMinutes($duration)
          
          Write-Host "â° Session started at: $(Get-Date)"
          Write-Host "â° Session will end at: $endTime"
          Write-Host ""
          
          # Countdown timer
          while ((Get-Date) -lt $endTime) {
              $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
              Write-Host "[$(Get-Date)] RDP Active - $remaining minutes remaining"
              
              # Every 5 minutes, show system status
              if ([math]::Round($remaining) % 5 -eq 0) {
                  $cpuLoad = (Get-Counter '\Processor(_Total)\% Processor Time').CounterSamples.CookedValue
                  $ramUsage = (Get-CimInstance Win32_OperatingSystem)
                  $usedRAM = [math]::Round(($ramUsage.TotalVisibleMemorySize - $ramUsage.FreePhysicalMemory) / 1MB, 2)
                  Write-Host "   ğŸ“Š Status: CPU: $cpuLoad% | RAM: ${usedRAM}GB/$ramGB GB used"
              }
              
              Start-Sleep -Seconds 60
          }
          
          Write-Host "â° Session time expired! Shutting down RDP..."
          
          # Cleanup (test mode only)
          if ("${{ github.event.inputs.test_mode }}" -eq 'yes') {
              Write-Host "ğŸ§¹ Cleaning up test user..."
              Remove-LocalUser -Name "TestUser64GB" -ErrorAction SilentlyContinue
          }
          
          Write-Host "âœ… Session ended"
        shell: pwsh
