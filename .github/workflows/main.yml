name: 64GB RDP Fast Test Mode

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (no persistence)'
        required: true
        default: 'yes'
        type: choice
        options:
        - 'yes'
        - 'no'
      duration:
        description: 'RDP session duration in minutes'
        required: false
        default: '120'
        type: string

jobs:
  setup-64gb-rdp:
    # IMPORTANT: This requires a self-hosted Windows runner with 64GB RAM
    runs-on: [self-hosted, windows, x64, 64gb]
    timeout-minutes: 240
    
    steps:
      - name: Validate Hardware Resources
        run: |
          Write-Host "=== SYSTEM VALIDATION ==="
          $mem = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object TotalPhysicalMemory
          $ramGB = [math]::Round($mem.TotalPhysicalMemory / 1GB, 2)
          Write-Host "Total RAM: $ramGB GB"
          
          if ($ramGB -lt 60) {
              Write-Error "âŒ INSUFFICIENT RAM: Need 64GB, found $ramGB GB"
              exit 1
          }
          
          $cpu = Get-CimInstance -ClassName Win32_Processor
          Write-Host "CPU: $($cpu.Name)"
          Write-Host "Cores: $($cpu.NumberOfCores)"
          Write-Host "Threads: $($cpu.NumberOfLogicalProcessors)"
          
          $disk = Get-CimInstance -ClassName Win32_LogicalDisk -Filter "DeviceID='C:'"
          $freeGB = [math]::Round($disk.FreeSpace / 1GB, 2)
          Write-Host "C: Drive Free Space: $freeGB GB"
          
          Write-Host "âœ… System validated for 64GB RDP"
        shell: pwsh

      - name: Fast RDP Configuration (Test Mode)
        run: |
          Write-Host "âš¡ FAST RDP CONFIGURATION STARTING..."
          
          # Disable Windows Defender for better performance (TEST MODE ONLY)
          if ("${{ github.event.inputs.test_mode }}" -eq 'yes') {
              Set-MpPreference -DisableRealtimeMonitoring $true
              Set-MpPreference -DisableBehaviorMonitoring $true
              Set-MpPreference -DisableBlockAtFirstSeen $true
              Write-Host "ğŸ›¡ï¸ Windows Defender disabled (test mode)"
          }
          
          # Optimize network performance
          Set-NetTCPSetting -SettingName InternetCustom -AutoTuningLevelLocal Experimental
          Set-NetTCPSetting -SettingName DatacenterCustom -AutoTuningLevelLocal Experimental
          
          # Enable RDP with minimal security for test mode
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          if ("${{ github.event.inputs.test_mode }}" -eq 'yes') {
              # Test mode: Disable NLA and security layer for faster connection
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxMonitors" -Value 4 -Force
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxResolution" -Value 4 -Force
              Write-Host "ğŸ”“ Test mode: NLA disabled"
          }
          
          # Configure firewall
          netsh advfirewall firewall delete rule name="RDP-64GB" 2>$null
          netsh advfirewall firewall add rule name="RDP-64GB" dir=in action=allow protocol=TCP localport=3389
          
          # Restart service
          Restart-Service TermService -Force
          Write-Host "âœ… RDP configured for fast connections"
        shell: pwsh

      - name: Create High-Performance Test User
        run: |
          # Generate simple password for test mode
          $simplePassword = "TestRDP64GB@123"
          
          if ("${{ github.event.inputs.test_mode }}" -eq 'no') {
              # For non-test mode, generate secure password
              Add-Type -AssemblyName System.Web
              $simplePassword = [System.Web.Security.Membership]::GeneratePassword(16, 4)
          }
          
          # Create user
          $securePass = ConvertTo-SecureString $simplePassword -AsPlainText -Force
          
          # Check if user exists
          $userExists = Get-LocalUser -Name "TestUser64GB" -ErrorAction SilentlyContinue
          if ($userExists) {
              Set-LocalUser -Name "TestUser64GB" -Password $securePass
              Write-Host "ğŸ”„ User password updated"
          } else {
              New-LocalUser -Name "TestUser64GB" -Password $securePass -AccountNeverExpires -PasswordNeverExpires
              Write-Host "ğŸ‘¤ New user created"
          }
          
          # Add to groups
          Add-LocalGroupMember -Group "Administrators" -Member "TestUser64GB" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TestUser64GB" -ErrorAction SilentlyContinue
          
          # Set password never expires
          Set-LocalUser -Name "TestUser64GB" -PasswordNeverExpires $true
          
          # Store credentials
          echo "RDP_USER=TestUser64GB" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$simplePassword" >> $env:GITHUB_ENV
          
          Write-Host "âœ… User configured: TestUser64GB"
        shell: pwsh

      - name: Optimize System Performance
        run: |
          Write-Host "ğŸš€ OPTIMIZING SYSTEM PERFORMANCE..."
          
          # Set power plan to high performance
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          
          # Disable visual effects for better RDP performance
          Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" -Name "VisualFXSetting" -Value 2
          
          # Optimize for background services
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl" -Name "Win32PrioritySeparation" -Value 38
          
          # Disable Windows animations
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name "UserPreferencesMask" -Value ([byte[]](144,18,3,128,16,0,0,0))
          
          Write-Host "âœ… System optimized for performance"
        shell: pwsh

      - name: Get Network Information
        run: |
          Write-Host "ğŸŒ NETWORK INFORMATION"
          
          # Get public IP
          $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org").Trim()
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          
          # Get local IP
          $localIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -like "*Ethernet*" -or $_.InterfaceAlias -like "*Wi-Fi*"} | Select-Object -First 1).IPAddress
          echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
          
          Write-Host "Public IP: $publicIP"
          Write-Host "Local IP: $localIP"
          
          # Test RDP port
          $portTest = Test-NetConnection -ComputerName $localIP -Port 3389 -WarningAction SilentlyContinue
          if ($portTest.TcpTestSucceeded) {
              Write-Host "âœ… RDP Port 3389 is open and accessible"
          } else {
              Write-Host "âš ï¸ RDP Port test failed locally"
          }
        shell: pwsh

      - name: Install Performance Monitoring Tools (Optional)
        if: ${{ github.event.inputs.test_mode == 'yes' }}
        run: |
          Write-Host "ğŸ“Š INSTALLING TEST TOOLS..."
          
          # Install Chocolatey (if not present)
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
              Set-ExecutionPolicy Bypass -Scope Process -Force
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          }
          
          # Install useful tools for testing
          choco install sysinternals -y --no-progress
          choco install cpu-z -y --no-progress
          choco install hwinfo -y --no-progress
          choco install 7zip -y --no-progress
          
          Write-Host "âœ… Test tools installed"
        shell: pwsh

      - name: Display RDP Access Information
        run: |
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "                     ğŸš€ 64GB RDP READY! ğŸš€"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸ“Œ CONNECTION DETAILS:"
          Write-Host "   Public IP: $env:PUBLIC_IP"
          Write-Host "   Local IP:  $env:LOCAL_IP"
          Write-Host "   Port:      3389"
          Write-Host ""
          Write-Host "ğŸ‘¤ CREDENTIALS:"
          Write-Host "   Username:  $env:RDP_USER"
          Write-Host "   Password:  $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "ğŸ”§ SYSTEM SPECS:"
          $mem = Get-CimInstance -ClassName Win32_ComputerSystem | Select-Object TotalPhysicalMemory
          $ramGB = [math]::Round($mem.TotalPhysicalMemory / 1GB, 2)
          Write-Host "   RAM:       $ramGB GB"
          $cpu = Get-CimInstance -ClassName Win32_Processor
          Write-Host "   CPU:       $($cpu.Name)"
          Write-Host ""
          Write-Host "â° SESSION DURATION: ${{ github.event.inputs.duration }} minutes"
          Write-Host "ğŸ”“ MODE: ${{ github.event.inputs.test_mode == 'yes' && 'TEST MODE (NLA Disabled)' || 'SECURE MODE' }}"
          Write-Host ""
          Write-Host "ğŸ’¡ TIPS:"
          Write-Host "   1. Use mstsc.exe to connect"
          Write-Host "   2. For test mode, uncheck 'Always ask for credentials'"
          Write-Host "   3. Set display to 1920x1080 for best performance"
          Write-Host ""
          Write-Host "âš ï¸  WARNING: This session will auto-terminate after ${{ github.event.inputs.duration }} minutes"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          
          # Save info to file
          $info = @"
64GB RDP ACCESS INFORMATION
===========================
Timestamp: $(Get-Date)
Connection:
  - Public IP: $env:PUBLIC_IP
  - Local IP:  $env:LOCAL_IP
  - Port:      3389

Credentials:
  - Username: $env:RDP_USER
  - Password: $env:RDP_PASSWORD

System:
  - RAM: $ramGB GB
  - CPU: $($cpu.Name)
  - Mode: ${{ github.event.inputs.test_mode == 'yes' && 'TEST' || 'SECURE' }}
  
Connection String:
  mstsc /v:$env:PUBLIC_IP
"@
          
          $info | Out-File -FilePath "$env:GITHUB_WORKSPACE\RDP_Access_Info.txt"
          Write-Host "ğŸ“„ Access info saved to RDP_Access_Info.txt"
        shell: pwsh

      - name: Active Session Timer
        run: |
          $duration = ${{ github.event.inputs.duration }}
          $endTime = (Get-Date).AddMinutes($duration)
          
          Write-Host "â° Session started at: $(Get-Date)"
          Write-Host "â° Session will end at: $endTime"
          Write-Host ""
          
          # Countdown timer
          while ((Get-Date) -lt $endTime) {
              $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
              Write-Host "[$(Get-Date)] RDP Active - $remaining minutes remaining"
              
              # Every 5 minutes, show system status
              if ([math]::Round($remaining) % 5 -eq 0) {
                  $cpuLoad = (Get-Counter '\Processor(_Total)\% Processor Time').CounterSamples.CookedValue
                  $ramUsage = (Get-CimInstance Win32_OperatingSystem)
                  $usedRAM = [math]::Round(($ramUsage.TotalVisibleMemorySize - $ramUsage.FreePhysicalMemory) / 1MB, 2)
                  Write-Host "   ğŸ“Š Status: CPU: $cpuLoad% | RAM: ${usedRAM}GB/$ramGB GB used"
              }
              
              Start-Sleep -Seconds 60
          }
          
          Write-Host "â° Session time expired! Shutting down RDP..."
          
          # Cleanup (test mode only)
          if ("${{ github.event.inputs.test_mode }}" -eq 'yes') {
              Write-Host "ğŸ§¹ Cleaning up test user..."
              Remove-LocalUser -Name "TestUser64GB" -ErrorAction SilentlyContinue
          }
          
          Write-Host "âœ… Session ended"
        shell: pwsh
