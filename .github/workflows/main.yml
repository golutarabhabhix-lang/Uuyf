name: üöÄ RDP-64GB Test Mode

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'RDP Duration (minutes)'
        required: true
        default: '120'
        type: choice
        options:
          - '60'
          - '120'
          - '240'
          - '480'
      region:
        description: 'Azure Region'
        required: false
        default: 'eastus'
        type: string

jobs:
  deploy-64gb-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      vm-ip: ${{ steps.get-vm-ip.outputs.vm-ip }}
      vm-name: ${{ steps.create-vm.outputs.vm-name }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Deploy 64GB Azure VM (Standard_D16s_v5)
        id: create-vm
        run: |
          VM_NAME="rdp-64gb-test-$(date +%s)"
          echo "vm-name=$VM_NAME" >> $GITHUB_OUTPUT
          
          az vm create \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name $VM_NAME \
            --image MicrosoftWindowsServer:WindowsServer:2022-datacenter-g2:latest \
            --size Standard_D16s_v5 \
            --admin-username githubuser \
            --admin-password $(openssl rand -base64 16) \
            --public-ip-sku Standard \
            --nic-delete-option Delete \
            --os-disk-delete-option Delete \
            --data-disk-sizes-gb 256 \
            --nsg "" \
            --custom-data ./cloud-init.ps1 \
            --location ${{ github.event.inputs.region }} \
            --output json \
            --verbose
          
          echo "‚úÖ 64GB VM created: $VM_NAME"

      - name: Open RDP Port (3389)
        run: |
          az vm open-port \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ steps.create-vm.outputs.vm-name }} \
            --port 3389 \
            --priority 100

      - name: Get VM Public IP
        id: get-vm-ip
        run: |
          PUBLIC_IP=$(az vm show \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ steps.create-vm.outputs.vm-name }} \
            --show-details \
            --query 'publicIps' -o tsv)
          
          echo "vm-ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "üåê Public IP: $PUBLIC_IP"

  configure-rdp:
    needs: deploy-64gb-vm
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Install WinRM Support
        uses: dawidd6/action-setup-winrm@v1
        with:
          host: ${{ needs.deploy-64gb-vm.outputs.vm-ip }}
          username: githubuser
          password: ${{ secrets.AZURE_VM_PASSWORD }}

      - name: Configure RDP via WinRM
        uses: appleboy/windows-ssh-action@v0.0.2
        with:
          host: ${{ needs.deploy-64gb-vm.outputs.vm-ip }}
          username: githubuser
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          script: |
            # Enable RDP
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
            
            # Configure Firewall
            New-NetFirewallRule -DisplayName "RDP-3389-Test" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow -Enabled True
            
            # Create Test User
            $password = ConvertTo-SecureString "TestRDP@123" -AsPlainText -Force
            New-LocalUser -Name "TestUser" -Password $password -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member "TestUser"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TestUser"
            
            # Set High Performance Power Plan
            powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
            
            # Restart RDP Service
            Restart-Service TermService -Force
            
            echo "‚úÖ RDP Configured Successfully"

      - name: Install Tailscale via WinRM
        uses: appleboy/windows-ssh-action@v0.0.2
        with:
          host: ${{ needs.deploy-64gb-vm.outputs.vm-ip }}
          username: githubuser
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          script: |
            # Download and Install Tailscale
            $tailscaleUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $installerPath = "$env:TEMP\tailscale.msi"
            
            Invoke-WebRequest -Uri $tailscaleUrl -OutFile $installerPath
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
            Remove-Item $installerPath -Force
            
            # Start Tailscale
            Start-Process -FilePath "$env:ProgramFiles\Tailscale\tailscale.exe" -ArgumentList "up", "--authkey=${{ secrets.TAILSCALE_AUTH_KEY }}", "--hostname=azure-64gb-test" -NoNewWindow -Wait
            
            # Get Tailscale IP
            $tailscaleIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            echo "TAILSCALE_IP=$tailscaleIP"
            
            # Test Connectivity
            Test-NetConnection -ComputerName $tailscaleIP -Port 3389
            echo "‚úÖ Tailscale Installed and Configured"

  performance-test:
    needs: configure-rdp
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Run Performance Tests
        uses: appleboy/windows-ssh-action@v0.0.2
        with:
          host: ${{ needs.deploy-64gb-vm.outputs.vm-ip }}
          username: githubuser
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          script: |
            # System Information
            systeminfo | findstr /C:"Total Physical Memory" /C:"Available Physical Memory" /C:"Processor(s)"
            
            # Performance Test
            Write-Host "üß™ Running Performance Tests..."
            
            # Memory Speed Test
            $memTest = Measure-Command {
                1..5 | ForEach-Object {
                    $array = New-Object byte[] 1GB
                    $array = $null
                    [GC]::Collect()
                }
            }
            Write-Host "Memory Test Time: $($memTest.TotalSeconds) seconds"
            
            # Disk Speed Test
            Write-Host "Testing Disk Speed..."
            $diskTest = "$env:TEMP\disktest.dat"
            $diskResult = Measure-Command {
                fsutil file createnew $diskTest 1073741824 | Out-Null
            }
            Remove-Item $diskTest -Force
            Write-Host "Disk Write Speed: $([math]::Round(1024/$diskResult.TotalSeconds, 2)) MB/s"
            
            # CPU Test
            Write-Host "Testing CPU..."
            $cpuTest = Measure-Command {
                $sum = 0
                for ($i = 0; $i -lt 10000000; $i++) {
                    $sum += [math]::Sqrt($i)
                }
            }
            Write-Host "CPU Calculation Time: $($cpuTest.TotalMilliseconds) ms"
            
            echo "‚úÖ Performance Tests Complete"

  rdp-access:
    needs: [deploy-64gb-vm, configure-rdp, performance-test]
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.duration }}
    
    steps:
      - name: Display RDP Connection Details
        run: |
          echo "=========================================="
          echo "üöÄ 64GB RDP READY FOR TESTING"
          echo "=========================================="
          echo "Public IP: ${{ needs.deploy-64gb-vm.outputs.vm-ip }}"
          echo "Username: TestUser"
          echo "Password: TestRDP@123"
          echo "Duration: ${{ github.event.inputs.duration }} minutes"
          echo ""
          echo "üîß System Specs:"
          echo "   - 64GB RAM"
          echo "   - 16 vCPUs"
          echo "   - 256GB SSD"
          echo "   - Tailscale VPN Installed"
          echo ""
          echo "üìå To connect via RDP:"
          echo "   mstsc /v:${{ needs.deploy-64gb-vm.outputs.vm-ip }}"
          echo ""
          echo "‚è∞ VM will auto-terminate after ${{ github.event.inputs.duration }} minutes"
          echo "=========================================="
          
          # Start countdown
          MINUTES=${{ github.event.inputs.duration }}
          SECONDS=$((MINUTES * 60))
          while [ $SECONDS -gt 0 ]; do
            MINS=$((SECONDS / 60))
            SECS=$((SECONDS % 60))
            printf "\r‚è∞ RDP Active: %02d:%02d remaining | CTRL+C to stop workflow early " $MINS $SECS
            sleep 1
            SECONDS=$((SECONDS - 1))
          done

  cleanup:
    needs: rdp-access
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Delete VM and Resources
        run: |
          if [ -n "${{ needs.deploy-64gb-vm.outputs.vm-name }}" ]; then
            echo "üßπ Cleaning up VM: ${{ needs.deploy-64gb-vm.outputs.vm-name }}"
            az vm delete \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ needs.deploy-64gb-vm.outputs.vm-name }} \
              --yes \
              --no-wait
            
            echo "‚úÖ Cleanup initiated. VM will be deleted shortly."
          else
            echo "‚ö†Ô∏è No VM to cleanup"
          fi
